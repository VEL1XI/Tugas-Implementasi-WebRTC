<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Call - Pion Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        header p {
            color: #a0a0a0;
        }

        .join-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            margin: 0 auto 30px;
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }

        .form-group input::placeholder {
            color: #888;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .video-section {
            display: none;
        }

        .video-section.active {
            display: block;
        }

        .room-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .room-info span {
            font-size: 14px;
        }

        .room-info strong {
            color: #00d4ff;
        }

        .videos-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-wrapper {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .video-wrapper video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            display: block;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }

        .local-video {
            border: 3px solid #00d4ff;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.active {
            background: #2ecc71;
            color: white;
        }

        .control-btn.inactive {
            background: #e74c3c;
            color: white;
        }

        .control-btn.end-call {
            background: #e74c3c;
            color: white;
            width: 70px;
            height: 70px;
        }

        .remote-videos {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #2ecc71;
        }

        .status-disconnected {
            background: #e74c3c;
        }

        #connectionStatus {
            text-align: center;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .users-list {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .users-list h3 {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .user-item {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }

        .user-item:last-child {
            margin-bottom: 0;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
        }

        footer a {
            color: #00d4ff;
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• WebRTC Video Call</h1>
            <p>Implementasi WebRTC menggunakan Pion (Golang) + JavaScript</p>
        </header>

        <!-- Join Section -->
        <div id="joinSection" class="join-section">
            <div class="form-group">
                <label for="roomId">Room ID</label>
                <input type="text" id="roomId" placeholder="Masukkan Room ID (contoh: room123)">
            </div>
            <div class="form-group">
                <label for="userId">Nama Anda</label>
                <input type="text" id="userId" placeholder="Masukkan nama Anda">
            </div>
            <button class="btn btn-primary" onclick="joinRoom()">
                üöÄ Gabung Room
            </button>
        </div>

        <!-- Video Call Section -->
        <div id="videoSection" class="video-section">
            <div class="room-info">
                <span>
                    <span class="status-indicator status-connected" id="statusIndicator"></span>
                    Room: <strong id="currentRoom"></strong> | Anda: <strong id="currentUser"></strong>
                </span>
                <button class="btn btn-danger" onclick="leaveRoom()">Keluar Room</button>
            </div>

            <div id="connectionStatus"></div>

            <div class="users-list" id="usersList">
                <h3>üë• Peserta Online:</h3>
                <div id="usersContainer"></div>
            </div>

            <div class="videos-container">
                <!-- Local Video -->
                <div class="video-wrapper local-video">
                    <video id="localVideo" autoplay muted playsinline></video>
                    <div class="video-label">üìπ Anda</div>
                </div>

                <!-- Remote Videos Container -->
                <div id="remoteVideos" class="remote-videos"></div>
            </div>

            <div class="controls">
                <button class="control-btn active" id="toggleVideo" onclick="toggleVideo()">
                    üìπ
                </button>
                <button class="control-btn active" id="toggleAudio" onclick="toggleAudio()">
                    üé§
                </button>
                <button class="control-btn end-call" onclick="leaveRoom()">
                    üìû
                </button>
            </div>
        </div>

        <footer>
            <p>Dibuat dengan ‚ù§Ô∏è menggunakan <a href="https://github.com/pion/webrtc" target="_blank">Pion WebRTC</a></p>
            <p><a href="/datachannel.html">Lihat Demo Data Channel ‚Üí</a></p>
        </footer>
    </div>

    <script>
        // Variabel global
        let ws = null;
        let localStream = null;
        let peerConnections = {};
        let roomId = '';
        let userId = '';
        let isVideoEnabled = true;
        let isAudioEnabled = true;

        // Konfigurasi ICE servers
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' }
            ]
        };

        // Fungsi untuk bergabung ke room
        async function joinRoom() {
            roomId = document.getElementById('roomId').value.trim();
            userId = document.getElementById('userId').value.trim();

            if (!roomId || !userId) {
                alert('Mohon isi Room ID dan Nama Anda!');
                return;
            }

            try {
                // Dapatkan akses ke kamera dan mikrofon
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                // Tampilkan video lokal
                document.getElementById('localVideo').srcObject = localStream;

                // Hubungkan ke WebSocket server
                connectWebSocket();

                // Tampilkan section video
                document.getElementById('joinSection').classList.add('hidden');
                document.getElementById('videoSection').classList.add('active');
                document.getElementById('currentRoom').textContent = roomId;
                document.getElementById('currentUser').textContent = userId;

            } catch (err) {
                console.error('Error accessing media devices:', err);
                alert('Gagal mengakses kamera/mikrofon. Pastikan browser Anda mengizinkan akses.');
            }
        }

        // Fungsi untuk menghubungkan WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateStatus('Terhubung ke server', 'success');
                
                // Kirim pesan join
                ws.send(JSON.stringify({
                    type: 'join',
                    roomId: roomId,
                    userId: userId
                }));
            };

            ws.onmessage = async (event) => {
                const msg = JSON.parse(event.data);
                console.log('Received:', msg.type);

                switch (msg.type) {
                    case 'users':
                        // Daftar user yang sudah ada di room
                        handleExistingUsers(msg.users);
                        break;

                    case 'user-joined':
                        // User baru bergabung
                        handleUserJoined(msg.userId);
                        break;

                    case 'user-left':
                        // User keluar
                        handleUserLeft(msg.userId);
                        break;

                    case 'offer':
                        // Terima offer SDP
                        await handleOffer(msg.userId, msg.sdp);
                        break;

                    case 'answer':
                        // Terima answer SDP
                        await handleAnswer(msg.userId, msg.sdp);
                        break;

                    case 'ice-candidate':
                        // Terima ICE candidate
                        await handleIceCandidate(msg.userId, msg.ice);
                        break;
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateStatus('Terputus dari server', 'error');
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                updateStatus('Error koneksi', 'error');
            };
        }

        // Handle daftar user yang sudah ada
        function handleExistingUsers(users) {
            users.forEach(user => {
                if (user !== userId) {
                    createPeerConnection(user, true);
                }
            });
            updateUsersList();
        }

        // Handle user baru bergabung
        function handleUserJoined(newUserId) {
            console.log(`User ${newUserId} joined`);
            updateStatus(`${newUserId} bergabung`, 'success');
            updateUsersList();
        }

        // Handle user keluar
        function handleUserLeft(leftUserId) {
            console.log(`User ${leftUserId} left`);
            updateStatus(`${leftUserId} keluar`, 'warning');
            
            // Hapus peer connection
            if (peerConnections[leftUserId]) {
                peerConnections[leftUserId].close();
                delete peerConnections[leftUserId];
            }

            // Hapus video element
            const videoContainer = document.getElementById(`video-${leftUserId}`);
            if (videoContainer) {
                videoContainer.remove();
            }

            updateUsersList();
        }

        // Buat peer connection baru
        async function createPeerConnection(targetUserId, isInitiator) {
            console.log(`Creating peer connection with ${targetUserId}, initiator: ${isInitiator}`);

            const pc = new RTCPeerConnection(iceServers);
            peerConnections[targetUserId] = pc;

            // Tambahkan local tracks
            localStream.getTracks().forEach(track => {
                pc.addTrack(track, localStream);
            });

            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    ws.send(JSON.stringify({
                        type: 'ice-candidate',
                        targetId: targetUserId,
                        ice: event.candidate.toJSON()
                    }));
                }
            };

            // Handle remote stream
            pc.ontrack = (event) => {
                console.log(`Received remote track from ${targetUserId}`);
                addRemoteVideo(targetUserId, event.streams[0]);
            };

            // Handle connection state
            pc.onconnectionstatechange = () => {
                console.log(`Connection state with ${targetUserId}: ${pc.connectionState}`);
                if (pc.connectionState === 'connected') {
                    updateStatus(`Terhubung dengan ${targetUserId}`, 'success');
                }
            };

            // Jika initiator, buat offer
            if (isInitiator) {
                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    
                    ws.send(JSON.stringify({
                        type: 'offer',
                        targetId: targetUserId,
                        sdp: pc.localDescription
                    }));
                } catch (err) {
                    console.error('Error creating offer:', err);
                }
            }

            return pc;
        }

        // Handle offer SDP
        async function handleOffer(fromUserId, sdp) {
            console.log(`Received offer from ${fromUserId}`);

            let pc = peerConnections[fromUserId];
            if (!pc) {
                pc = await createPeerConnection(fromUserId, false);
            }

            try {
                await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                ws.send(JSON.stringify({
                    type: 'answer',
                    targetId: fromUserId,
                    sdp: pc.localDescription
                }));
            } catch (err) {
                console.error('Error handling offer:', err);
            }
        }

        // Handle answer SDP
        async function handleAnswer(fromUserId, sdp) {
            console.log(`Received answer from ${fromUserId}`);

            const pc = peerConnections[fromUserId];
            if (pc) {
                try {
                    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                } catch (err) {
                    console.error('Error handling answer:', err);
                }
            }
        }

        // Handle ICE candidate
        async function handleIceCandidate(fromUserId, ice) {
            const pc = peerConnections[fromUserId];
            if (pc && ice) {
                try {
                    await pc.addIceCandidate(new RTCIceCandidate(ice));
                } catch (err) {
                    console.error('Error adding ICE candidate:', err);
                }
            }
        }

        // Tambahkan video remote
        function addRemoteVideo(peerId, stream) {
            let videoContainer = document.getElementById(`video-${peerId}`);
            
            if (!videoContainer) {
                videoContainer = document.createElement('div');
                videoContainer.id = `video-${peerId}`;
                videoContainer.className = 'video-wrapper';
                videoContainer.innerHTML = `
                    <video autoplay playsinline></video>
                    <div class="video-label">üë§ ${peerId}</div>
                `;
                document.getElementById('remoteVideos').appendChild(videoContainer);
            }

            const video = videoContainer.querySelector('video');
            video.srcObject = stream;
        }

        // Update daftar users
        function updateUsersList() {
            const container = document.getElementById('usersContainer');
            const allUsers = [userId, ...Object.keys(peerConnections)];
            
            container.innerHTML = allUsers.map(user => `
                <div class="user-item">
                    <span class="status-indicator status-connected"></span>
                    ${user}${user === userId ? ' (Anda)' : ''}
                </div>
            `).join('');
        }

        // Toggle video
        function toggleVideo() {
            isVideoEnabled = !isVideoEnabled;
            localStream.getVideoTracks().forEach(track => {
                track.enabled = isVideoEnabled;
            });

            const btn = document.getElementById('toggleVideo');
            btn.className = `control-btn ${isVideoEnabled ? 'active' : 'inactive'}`;
            btn.textContent = isVideoEnabled ? 'üìπ' : 'üö´';
        }

        // Toggle audio
        function toggleAudio() {
            isAudioEnabled = !isAudioEnabled;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = isAudioEnabled;
            });

            const btn = document.getElementById('toggleAudio');
            btn.className = `control-btn ${isAudioEnabled ? 'active' : 'inactive'}`;
            btn.textContent = isAudioEnabled ? 'üé§' : 'üîá';
        }

        // Keluar dari room
        function leaveRoom() {
            // Kirim pesan leave
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'leave' }));
                ws.close();
            }

            // Tutup semua peer connections
            Object.values(peerConnections).forEach(pc => pc.close());
            peerConnections = {};

            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            // Reset UI
            document.getElementById('videoSection').classList.remove('active');
            document.getElementById('joinSection').classList.remove('hidden');
            document.getElementById('remoteVideos').innerHTML = '';
            document.getElementById('localVideo').srcObject = null;
        }

        // Update status
        function updateStatus(message, type) {
            const status = document.getElementById('connectionStatus');
            status.textContent = message;
            status.style.background = type === 'success' ? 'rgba(46, 204, 113, 0.3)' : 
                                      type === 'error' ? 'rgba(231, 76, 60, 0.3)' : 
                                      'rgba(241, 196, 15, 0.3)';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                status.textContent = '';
                status.style.background = 'transparent';
            }, 3000);
        }

        // Handle page unload
        window.onbeforeunload = () => {
            leaveRoom();
        };
    </script>
</body>
</html>
